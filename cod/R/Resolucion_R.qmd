---
title: "Resolucion_R"
format: html
---

##Realice un resumen de 5 números incluyendo el promedio. Para las columnas numéricas
 
```{r}
#Procedemos como vimos con la carga del archivo par trabajar:

#Como es un archivo txt usamos:
getwd()

library(here)

data <- read.table(here("data", "moras.txt"), header = TRUE, sep = ",", dec = ".", stringsAsFactors = FALSE)

#Primero veamos el formato tq:
str(data)

#Necesitamos cambiar las variables para proceder:
data$SALARIO <- gsub("\"", "", data$SALARIO)      
data$SALARIO <- gsub(",", ".", data$SALARIO) 
data$SALARIO <- as.numeric(data$SALARIO)

str(data) #Listo ya tenemos todo bien :)

#Ahora realizamos el resumen solicitado:

resumen5.Num <- data.frame(
  Números = c("Minimo", "Maximo", "Cuartil1", "Mediana(cuartil2)", "cuartil3", "promedio"),
  Salario = c(
    min(data$SALARIO, na.rm = TRUE),
    max(data$SALARIO, na.rm = TRUE),
    quantile(data$SALARIO, 0.25, na.rm = TRUE),
    median(data$SALARIO, na.rm = TRUE),
    quantile(data$SALARIO, 0.75, na.rm = TRUE),
    mean(data$SALARIO, na.rm = TRUE)
  ),
  Edad = c(
    min(data$EDAD, na.rm = TRUE),
    max(data$EDAD, na.rm = TRUE),
    quantile(data$EDAD, 0.25, na.rm = TRUE),
    median(data$EDAD, na.rm = TRUE),
    quantile(data$EDAD, 0.75, na.rm = TRUE),
    mean(data$EDAD, na.rm = TRUE)
  )
)
resumen5.Num

```
 
 
##Realice una columna donde se identifiquen valores atípicos haciendo uso del Z-Score, de tal manera que si el valor absoluto del Z-Score es mayor a 1,96 se considera un valor atípico. Esto para la columna de salario y edad.

Se asume que ya se conoce que es una Z-Score

```{r}
library(dplyr)

data <- data %>%
  mutate(
    Z.SAL = (SALARIO - mean(SALARIO, na.rm = TRUE)) / sd(SALARIO, na.rm = TRUE),
    VALORES.SALARIO = ifelse(abs(Z.SAL) > 1.96, "ATIPICO", "NORMAL"),

    Z.EDAD = (EDAD - mean(EDAD, na.rm = TRUE)) / sd(EDAD, na.rm = TRUE),
    VALORES.EDAD = ifelse(abs(Z.EDAD) > 1.96, "ATIPICO", "NORMAL")
  )
data %>% 
  select(Z.SAL, VALORES.SALARIO, Z.EDAD, VALORES.EDAD) %>% 
  head(10)
```

##Detecte el porcentaje de valores faltantes en cada una de las columnas.

```{r}
porcentaje.na <- sapply(data, function(x) {
  sum(is.na(x)) / length(x) * 100
})
na <- data.frame(
  COLUMNA = names(porcentaje.na),
  PORCENTAJE = round(porcentaje.na, 2)
)
knitr::kable(na, caption = "Porcentaje de valores nulos en cada columna.") #Esto es simplemente para que la tabla se vea mas estetica
```

##Impute los valores faltantes haciendo uso de algún método de su preferencia.

```{r}
moda <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))] #Aca calculamos el valor que mas se repite es un vector, donde primero obtenemos sus valores unicos (base para entender sus frecuencicas). Posterior a ello, cuenta cuantas veces aparece cada uno utilizando match y tabulate, identifica cual tiene la frecuencia mas alta con which.max y devuelve ese valor, es decir, da la moda de un conjunto de datos.
}

data <- data %>%
  mutate(
    SALARIO.IMPUTADO = ifelse(
      is.na(SALARIO) | SALARIO == "", #Aca vemos las dos posibilidades de que este vacio o tenga un dato NA
      mean(as.numeric(SALARIO), na.rm = TRUE),#Sacamos promedio para sustituir NAs
      SALARIO
    ),
    
    EDAD.IMPUTADOS = ifelse(
      is.na(EDAD) | EDAD == "",
      round(mean(as.numeric(EDAD), na.rm = TRUE)),#Aca redondeo pues los datos de la tabla son enteros y la edad promedio es decimal.
      EDAD
    ),
    
    TIPO.ASEGURAMIENTO.IMPUTADO = ifelse(
      is.na(TIPO_ASEGURAMIENTO) | TIPO_ASEGURAMIENTO == "",
      moda(TIPO_ASEGURAMIENTO), #Encontramos la moda de os tipos de aseguramiento para que reemplacen los NAs
      TIPO_ASEGURAMIENTO
    )
  )

imputados <- data %>% 
  select (SALARIO.IMPUTADO, EDAD.IMPUTADOS, TIPO.ASEGURAMIENTO.IMPUTADO) %>% 
  head(5)

knitr::kable(imputados, caption = "Datos imputados por las columnas vacias.") #Nuevamente arreglamos la esteticad de los resultados
```


##Realice gráficos donde se vea la cantidad de individuos por cada categoría. Analice los resultados.


```{r}
library(ggplot2)

conteo.categoria <- function(df, variable) {
  df %>%
    group_by(across({{variable}})) %>%
    summarise(CONTEO = n(), .groups = "drop") #Aca realizamos una funcion de conteo para las categorias tal que, recibe un data frame y una variable que es la columna dada. entonces agrupamos por las diferntes variables que presenta la columna dada y realiza un conteo de cada una y devuelve una tabla con los diferentes grupos dentreo de la columna y su conteo especifico.
}
conteo.sexo <- conteo.categoria(data, SEXO)
conteo.tipo <- conteo.categoria(data, TIPO_ASEGURAMIENTO)
conteo.sector <- conteo.categoria(data, SECTOR)
conteo.activo <- conteo.categoria(data, INDICADOR_ACTIVO)
conteo.extranjero <- conteo.categoria(data, INDICADOR.EXTRANJERO)
conteo.moroso <- conteo.categoria(data, INDICADOR_MOROSO) #Aca preparamos todos los conteos para realizar los respectivos graficos.

grafico.cat <- function(df, variable, horizontal = FALSE) {#Aca realizamos una funcion para aplizar a cada tipo de variable categorica y lograr graficarlas.
  
  p <- ggplot(df, aes(x = .data[[variable]], 
                      y = CONTEO, 
                      fill = .data[[variable]])) +
    geom_col() +
    geom_text(
      aes(label = CONTEO),
      size = 4,
      vjust = ifelse(horizontal, 0.5, -0.3),
      hjust = ifelse(horizontal, -0.2, 0.5)
    ) +
    theme_minimal(base_size = 13) +
    theme(legend.position = "none")
  
  if (horizontal) {
    p <- p + coord_flip()
  }
return(p)  
}

```

Analisis de resultados:

```{r}
#Ahora procedemos a graficar cada variable categorica: 
grafico.cat(conteo.sexo, "SEXO")
```

Cabe destacar que, dado que la población masculina es mayor entre los asegurados, las tendencias observadas tienden a reflejar principalmente el comportamiento de los hombres. Esto implica que cualquier análisis agregado podría estar sesgado hacia patrones masculinos, y sería recomendable considerar desagregaciones por sexo para obtener conclusiones más equilibradas pues pueden conllevar a analsis sesgados. 


```{r}
grafico.cat(conteo.tipo, "TIPO_ASEGURAMIENTO")
```

La mayoría de los asegurados pertenece al grupo de Asalariados, lo que indica que el análisis del conjunto de datos estará fuertemente influenciado por sus características y comportamientos, como la estabilidad laboral, la afiliación regular y la utilización de servicios de salud vinculados al empleo. En contraste, categorías como Convenios Especiales y Pensionados en su propio sistema tienen una participación muy baja, lo que sugiere que las tendencias observadas podrían no reflejar adecuadamente la situación de estos grupos. En consecuencia, el dominio de los asalariados implica que cualquier conclusión general del sistema asegurador estará mayormente orientada por este segmento.


```{r}
grafico.cat(conteo.sector, "SECTOR")
```

Se observa que gran parte de los datos corresponde al sector privado, lo que hace que el análisis se centre principalmente en su comportamiento. Esto implica que las tendencias identificadas reflejan sobre todo los patrones de aseguramiento, uso de servicios y riesgos de los afiliados del sector privado, dejando menos visibilidad sobre el comportamiento del sector público. Por ello, las conclusiones podrían no ser completamente representativas de toda la población asegurada, y sería recomendable complementar con información del sector público para tener un panorama más completo del sistema de aseguramiento.


```{r}
grafico.cat(conteo.activo, "INDICADOR_ACTIVO", horizontal = TRUE)
```

Se denota una predominancia de los asegurados con indicadores de activos, por lo que se toma una vision principalmente enfocada en personas que poseen seguros vigentes, viendo asi la cobertura y el comportamiento en los servicios de asegurados, sin embargo, al ver esa perspectiva de manera mayoritaria se puede perder el hilo de aquellos que no tengan una cobertura actual. 

```{r}
grafico.cat(conteo.extranjero, "INDICADOR.EXTRANJERO")
```

Dado que la mayor parte de los datos corresponde a asegurados no extranjeros, se puede asumir que el análisis representa principalmente la visión nacional del sistema de aseguramiento. Esto permite identificar las características, comportamientos y patrones predominantes entre los asegurados nacionales, aunque limita la representatividad sobre la población extranjera dentro del conjunto de datos.

```{r}
grafico.cat(conteo.moroso, "INDICADOR_MOROSO")
```

El cumplimiento de pagos por parte de los asegurados es alto, dado que la proporción de morosos es baja en comparación con los que mantienen sus cuotas al día. Esto sugiere que se pueden implementar seguros más dependientes del pago puntual, contando con un riesgo reducido por incumplimiento.


##Realice un gráfico para cada una de las variables categóricas en donde se vea el porcentaje de personas morosa por cada clase. Analice los resultados.

```{r}
#Para este ejercicio procedemos por la misma metodología tq:
porcentaje.morosos <- function(df, variable) {
  df %>%
    group_by(across(all_of(variable))) %>%
    summarise(
      total = n(),
      morosos = sum(INDICADOR_MOROSO == "SI", na.rm = TRUE),
      porcentaje = morosos / total * 100,
      .groups = "drop" #Vea que nuevamente es una funcion donde tenemos qu recibir un df y la columna por ver, que seria la variable categorica luego se agrupa  conforme dicha variable y se cuenta la cantidad de datos y morosos en relacion a la misma para luego dividirla con respecto a los subgrupos categoricos de dicha variable mediante el calculo del porcentaje. 
    )
}

#Creamos una funcion para graficas de morosos:
grafico.morosos <- function(df, variable, horizontal = FALSE) {
  p <- ggplot(df, aes_string(x = variable, y = "porcentaje", fill = variable)) +
    geom_col() +
    geom_text(aes_string(label = "paste0(round(porcentaje,1),'%')"),
              vjust = ifelse(horizontal, 0.5, -0.3),
              hjust = ifelse(horizontal, -0.2, 0.5),
              size = 4) +
    labs(y = "Porcentaje de morosos", x = NULL, title = paste("Morosidad por", variable)) +
    theme_minimal(base_size = 13) +
    theme(legend.position = "none")
  
  if(horizontal) p <- p + coord_flip()
  return(p)
}

# calculamos el porcentaje de morosos para graficar:
morosos.sexo <- porcentaje.morosos(data, "SEXO")
morosos.tipo <- porcentaje.morosos(data, "TIPO_ASEGURAMIENTO")
morosos.sector <- porcentaje.morosos(data, "SECTOR")
morosos.activo <- porcentaje.morosos(data, "INDICADOR_ACTIVO")
morosos.extranjero <- porcentaje.morosos(data, "INDICADOR.EXTRANJERO")

```

Analisis de resultados:

```{r}
#Ahora procedemos a graficar cada variable categorica: 
grafico.morosos(morosos.sexo, "SEXO")

grafico.morosos(morosos.tipo, "TIPO_ASEGURAMIENTO", horizontal = TRUE)

grafico.morosos(morosos.sector, "SECTOR")

grafico.morosos(morosos.activo, "INDICADOR_ACTIVO", horizontal = TRUE)

grafico.morosos(morosos.extranjero, "INDICADOR.EXTRANJERO", horizontal = TRUE)
```

Con los graficos ya hechos, se noto que los niveles de morosidad son relativamente altos entre los trabajadores independientes y las personas que no tienen un seguro activo. Esto es lógico en el caso de quienes no poseen seguro activo, ya que la morosidad puede acumularse por falta de pago y posterior cancelación. Por otro lado, es preocupante que los trabajadores independientes descuiden el pago de sus cuotas regularmente. También se identifican variables con morosidad igual a cero: por ejemplo, los pensionados en su propio sistema no presentan morosidad, dado que cuentan con un seguro privado estable; de manera similar, los convenios especiales de asegurados voluntarios muestran bajos niveles de morosidad, probablemente por políticas organizadas de pago y por la menor cantidad de seguros cubiertos. Finalmente, la morosidad en las demás variables categóricas oscila entre el 13% y el 24%, lo cual puede deberse a las diversas condiciones económicas de cada sector y a posibles crisis imprevistas.



##Para las variables numéricas realice gráficos de barras donde se ponga un color de acuerdo a si es moroso o no. Analice los resultados.

```{r}

```


